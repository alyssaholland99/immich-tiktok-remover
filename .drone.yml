---
kind: pipeline
type: docker
name: stable

steps:
  - name: docker build (stable)
    when:
      branch:
        include:
          - master
          - stable/*
          - stable-full/*
      event:
        include:
          - push
          - tag
      ref:
        include:
          - refs/tags/v*
    image: plugins/docker
    settings:
      username:
        from_secret: DOCKERHUB_USER
      password:
        from_secret: DOCKERHUB_PASS
      repo:
        from_secret: DOCKERHUB_REPOSITORY
      tags:
        - stable

---
kind: pipeline
type: docker
name: stable-lite

steps:
  - name: setup lite
    when:
      branch:
        include:
          - master
          - stable/*
          - stable-lite/*
      event:
        include:
          - push
          - tag
      ref:
        include:
          - refs/tags/v*
    image: plugins/docker
    commands:
      - ./make_lite.sh

  - name: docker build (lite)
    when:
      branch:
        include:
          - master
          - stable/*
          - stable-lite/*
      event:
        include:
          - push
          - tag
      ref:
        include:
          - refs/tags/v*
    image: plugins/docker
    settings:
      username:
        from_secret: DOCKERHUB_USER
      password:
        from_secret: DOCKERHUB_PASS
      repo:
        from_secret: DOCKERHUB_REPOSITORY
      tags:
        - stable-lite

---
kind: pipeline
type: docker
name: other-branches

steps:
  - name: docker build (feature)
    when:
      branch:
        include:
          - feature/*
    image: plugins/docker
    settings:
      username:
        from_secret: DOCKERHUB_USER
      password:
        from_secret: DOCKERHUB_PASS
      repo:
        from_secret: DOCKERHUB_REPOSITORY
      tags:
        - edgerunner

  - name: docker build (testing)
    when:
      branch:
        exclude:
          - master
          - feature/*
          - stable/*
          - stable-lite/*
          - docker_image_lite
    image: plugins/docker
    settings:
      username:
        from_secret: DOCKERHUB_USER
      password:
        from_secret: DOCKERHUB_PASS
      repo:
        from_secret: DOCKERHUB_REPOSITORY
      tags:
        - testing
